<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kontrol Pompa - Ruang Kebon</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .header h1 {
        color: #2ecc71;
      }
      .back-button {
        display: inline-block;
        padding: 10px 20px;
        background: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .control-panel {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 30px;
        border-left: 5px solid #2ecc71;
      }
      .pompa-status {
        font-size: 3em;
        font-weight: bold;
        margin: 20px 0;
        padding: 20px;
        border-radius: 10px;
        transition: all 0.3s ease;
      }
      .pompa-on {
        background: #d4edda;
        color: #155724;
        border: 3px solid #28a745;
      }
      .pompa-off {
        background: #f8d7da;
        color: #721c24;
        border: 3px solid #dc3545;
      }
      .control-buttons {
        margin: 30px 0;
      }
      .btn {
        padding: 15px 30px;
        margin: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2em;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .btn-on {
        background: #28a745;
        color: white;
      }
      .btn-on:hover {
        background: #218838;
        transform: scale(1.05);
      }
      .btn-off {
        background: #dc3545;
        color: white;
      }
      .btn-off:hover {
        background: #c82333;
        transform: scale(1.05);
      }
      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
      }
      .status-card {
        width: 100%;
        text-align: left;
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      #status {
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
        text-align: center;
      }
      .online {
        background: #d4edda;
        color: #155724;
      }
      .offline {
        background: #f8d7da;
        color: #721c24;
      }
      .data-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #f1f1f1;
      }
      .auto-control {
        margin: 20px 0;
        padding: 20px;
        background: #e8f4f8;
        border-radius: 10px;
      }
      .schedule-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: white;
        border-radius: 5px;
      }
      .blink {
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .device-warning {
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.9em;
      }
      .sync-status {
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        margin-left: 10px;
      }
      .sync-ok {
        background: #d4edda;
        color: #155724;
      }
      .sync-warning {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="index.html" class="back-button">‚Üê Kembali ke Dashboard</a>

      <div class="header">
        <h1>üîå Kontrol Pompa Air - Ruang Kebon</h1>
        <p>Sistem Kontrol Otomatis dan Manual Pengairan Kebun</p>
      </div>

      <div class="status-card">
        <h3>Status Sistem Pompa</h3>
        <div id="status" class="offline">
          üî¥ OFFLINE - Menunggu koneksi perangkat pompa...
        </div>
        <div id="deviceInfo">Device ID: --</div>
        <div id="lastSeen">Last seen: --</div>
        <div id="syncStatus" class="sync-status sync-warning" style="display: none;">
          ‚ö†Ô∏è Menunggu sinkronisasi status...
        </div>
        <div id="deviceWarning" class="device-warning" style="display: none;">
          ‚ö†Ô∏è Device pompa khusus belum terdeteksi. Pastikan ESP32 pompa terhubung.
        </div>
      </div>

      <div class="control-panel">
        <h2>Status Pompa Saat Ini</h2>
        <div id="pompa-status" class="pompa-off">üî¥ POMPA MATI</div>

        <div id="pompa-info">
          <p>Mode: <span id="pompa-mode">--</span></p>
          <p>Status Aktual: <span id="actual-status">--</span></p>
          <p>Terakhir diupdate: <span id="last-updated">--</span></p>
        </div>

        <div class="control-buttons">
          <button class="btn btn-on" onclick="controlPompa('on')" id="btn-on" disabled>
            üöÄ NYALAKAN POMPA
          </button>
          <button
            class="btn btn-off"
            onclick="controlPompa('off')"
            id="btn-off"
            disabled
          >
            ‚èπÔ∏è MATIKAN POMPA
          </button>
        </div>

        <div class="auto-control">
          <h3>‚è∞ Kontrol Otomatis</h3>
          <p>Jadwal penyiraman otomatis:</p>
          <div class="schedule-item">
            <span>Pagi: 06:00 - 06:15</span>
            <span id="schedule-morning">‚è≥ Menunggu...</span>
          </div>
          <div class="schedule-item">
            <span>Sore: 16:00 - 16:15</span>
            <span id="schedule-evening">‚è≥ Menunggu...</span>
          </div>
          <button class="btn" onclick="toggleAutoMode()" id="btn-auto" disabled>
            üîÑ Aktifkan Mode Otomatis
          </button>
        </div>
      </div>

      <div class="data-table">
        <h3>Riwayat Kontrol Pompa</h3>
        <table>
          <thead>
            <tr>
              <th>Waktu</th>
              <th>Status</th>
              <th>Mode</th>
              <th>Dikontrol Oleh</th>
              <th>Sumber</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div
        style="
          margin-top: 20px;
          padding: 15px;
          background: #fff3cd;
          border-radius: 8px;
        "
      >
        <h4>‚ö†Ô∏è Perhatian:</h4>
        <p>‚Ä¢ Dashboard akan selalu menampilkan status AKTUAL dari ESP32 pompa</p>
        <p>‚Ä¢ Kontrol manual hanya mengirim perintah, status akan update otomatis</p>
        <p>‚Ä¢ Pastikan ESP32 pompa mengirim data status secara berkala</p>
      </div>
    </div>

    <script>
      let refreshInterval;
      let isAutoMode = false;
      let currentPompaStatus = false;
      let isPompaDeviceOnline = false;
      let lastPompaData = null;
      let isSynced = false;

      // PERBAIKAN: Load data khusus untuk device pompa
      function loadData() {
        fetch("/api/status/all")
          .then((response) => response.json())
          .then((data) => {
            console.log("üìä All Status Data:", data);
            processPompaData(data);
          })
          .catch((error) => {
            console.error("Error fetching status:", error);
            setOfflineStatus();
          });
      }

      // PERBAIKAN: Process data khusus untuk device pompa
      function processPompaData(data) {
        const pompaSensor = data.sensors.pompa;
        const deviceStatus = data.device_status;
        
        console.log("üîß Pompa Sensor Data:", pompaSensor);
        console.log("üîß Device Status:", deviceStatus);

        // Cek apakah ada device pompa yang online
        const pompaDevices = findPompaDevices(data);
        
        if (pompaDevices.length > 0) {
          // Ada device pompa online
          const pompaDevice = pompaDevices[0]; // Ambil device pompa pertama
          isPompaDeviceOnline = true;
          
          updateDeviceStatus({
            isOnline: true,
            lastSeen: pompaSensor.lastUpdate,
            deviceId: pompaDevice.deviceId
          });

          // PERBAIKAN: Update display dengan data aktual dari ESP32
          if (pompaSensor.data && Object.keys(pompaSensor.data).length > 0) {
            lastPompaData = pompaSensor.data;
            updateDisplayFromESP32(pompaSensor.data);
            checkSyncStatus(pompaSensor.data);
          } else {
            // Data pompa kosong, tampilkan status default
            updateDisplayFromESP32({ status: false, mode: "manual" });
          }
          
        } else {
          // Tidak ada device pompa online
          isPompaDeviceOnline = false;
          setOfflineStatus();
        }

        loadHistory();
      }

      // PERBAIKAN: Cari device pompa berdasarkan data sensors
      function findPompaDevices(data) {
        const pompaDevices = [];
        
        // Cek semua sensor data untuk device yang mengandung "POMPA"
        Object.keys(data.sensors).forEach(sensorType => {
          const sensor = data.sensors[sensorType];
          if (sensor.data && sensor.data.deviceId) {
            const deviceId = sensor.data.deviceId;
            if (deviceId.includes("POMPA") || 
                deviceId.includes("pompa") || 
                deviceId.includes("Pompa") ||
                sensorType === "pompa") {
              pompaDevices.push({
                deviceId: deviceId,
                sensorType: sensorType,
                lastUpdate: sensor.lastUpdate
              });
            }
          }
        });
        
        console.log("üîç Found Pompa Devices:", pompaDevices);
        return pompaDevices;
      }

      // PERBAIKAN BARU: Update display berdasarkan data aktual dari ESP32
      function updateDisplayFromESP32(data) {
        console.log("üîÑ Update Display from ESP32:", data);
        
        if (data.status !== undefined) {
          const pompaStatus = document.getElementById("pompa-status");
          const actualStatusElement = document.getElementById("actual-status");

          // SELALU update status berdasarkan data dari ESP32
          currentPompaStatus = data.status;

          if (data.status) {
            // Pompa ON - Status dari ESP32
            pompaStatus.className = "pompa-status pompa-on";
            pompaStatus.innerHTML = "üíß POMPA MENYALA";
            actualStatusElement.textContent = "ON (Dari ESP32)";
            actualStatusElement.style.color = "#28a745";
          } else {
            // Pompa OFF - Status dari ESP32
            pompaStatus.className = "pompa-status pompa-off";
            pompaStatus.innerHTML = "üî¥ POMPA MATI";
            actualStatusElement.textContent = "OFF (Dari ESP32)";
            actualStatusElement.style.color = "#dc3545";
          }

          // Update button states berdasarkan status aktual
          updateButtonStates();

          document.getElementById("pompa-mode").textContent = data.mode || "manual";
          document.getElementById("last-updated").textContent = 
            new Date().toLocaleTimeString();

          isAutoMode = data.mode === "auto";
          updateAutoButton();
          updateSchedule();
        }
      }

      // PERBAIKAN: Update state tombol berdasarkan status aktual
      function updateButtonStates() {
        const btnOn = document.getElementById("btn-on");
        const btnOff = document.getElementById("btn-off");

        if (currentPompaStatus) {
          // Pompa sedang ON
          btnOn.disabled = true;
          btnOff.disabled = false;
        } else {
          // Pompa sedang OFF
          btnOn.disabled = false;
          btnOff.disabled = true;
        }
      }

      // PERBAIKAN BARU: Cek status sinkronisasi
      function checkSyncStatus(data) {
        const syncElement = document.getElementById("syncStatus");
        
        if (data && data.status !== undefined) {
          syncElement.style.display = "inline-block";
          syncElement.className = "sync-status sync-ok";
          syncElement.textContent = "‚úÖ Status tersinkronisasi";
          isSynced = true;
        } else {
          syncElement.style.display = "inline-block";
          syncElement.className = "sync-status sync-warning";
          syncElement.textContent = "‚ö†Ô∏è Menunggu data status...";
          isSynced = false;
        }
      }

      function loadHistory() {
        fetch("/api/all/pompa")
          .then((response) => response.json())
          .then((data) => {
            // Filter hanya data dari device pompa
            const pompaHistory = data.data.filter(item => 
              item.deviceId && (
                item.deviceId.includes("POMPA") || 
                item.deviceId.includes("pompa") || 
                item.deviceId.includes("Pompa")
              )
            );
            updateTable(pompaHistory.slice(-10));
          })
          .catch((error) => {
            console.error("Error loading history:", error);
          });
      }

      // PERBAIKAN: Update device status khusus pompa
      function updateDeviceStatus(status) {
        const statusElement = document.getElementById("status");
        const lastSeenElement = document.getElementById("lastSeen");
        const deviceInfoElement = document.getElementById("deviceInfo");
        const warningElement = document.getElementById("deviceWarning");

        if (status.isOnline && isPompaDeviceOnline) {
          statusElement.className = "online";
          statusElement.textContent = "‚úÖ ONLINE - Terhubung ke Kontroler Pompa";
          
          if (status.lastSeen) {
            const lastSeen = new Date(status.lastSeen);
            const now = new Date();
            const diffMinutes = Math.round((now - lastSeen) / 60000);
            lastSeenElement.textContent = `Last seen: ${lastSeen.toLocaleString()} (${diffMinutes} menit lalu)`;
          }

          if (status.deviceId) {
            deviceInfoElement.textContent = `Device ID: ${status.deviceId}`;
          }

          warningElement.style.display = "none";
          
          // Enable kontrol buttons
          document.getElementById("btn-on").disabled = false;
          document.getElementById("btn-off").disabled = false;
          document.getElementById("btn-auto").disabled = false;
          
        } else {
          setOfflineStatus();
        }
      }

      // PERBAIKAN: Set status offline
      function setOfflineStatus() {
        const statusElement = document.getElementById("status");
        const deviceInfoElement = document.getElementById("deviceInfo");
        const lastSeenElement = document.getElementById("lastSeen");
        const warningElement = document.getElementById("deviceWarning");
        const syncElement = document.getElementById("syncStatus");

        statusElement.className = "offline";
        statusElement.textContent = "üî¥ OFFLINE - Kontroler Pompa tidak terhubung";
        deviceInfoElement.textContent = "Device ID: --";
        lastSeenElement.textContent = "Last seen: --";
        syncElement.style.display = "none";
        
        // Tampilkan warning jika ada device lain tapi bukan pompa
        warningElement.style.display = "block";
        
        // Disable kontrol buttons
        document.getElementById("btn-on").disabled = true;
        document.getElementById("btn-off").disabled = true;
        document.getElementById("btn-auto").disabled = true;
        
        // Set pompa status to OFF
        document.getElementById("pompa-status").className = "pompa-status pompa-off";
        document.getElementById("pompa-status").innerHTML = "üî¥ POMPA MATI";
        document.getElementById("pompa-mode").textContent = "--";
        document.getElementById("actual-status").textContent = "--";
        document.getElementById("last-updated").textContent = "--";
      }

      // PERBAIKAN: Kontrol pompa - hanya mengirim perintah, status akan update otomatis
      function controlPompa(action) {
        if (!isPompaDeviceOnline) {
          showNotification("‚ùå Device pompa offline, tidak dapat mengontrol", "error");
          return;
        }

        const button = action === 'on' ? document.getElementById("btn-on") : document.getElementById("btn-off");
        const originalText = button.innerHTML;

        button.innerHTML = "‚è≥ Mengirim perintah...";
        button.disabled = true;

        // PERBAIKAN: Tampilkan status "menunggu konfirmasi"
        const pompaStatus = document.getElementById("pompa-status");
        const actualStatusElement = document.getElementById("actual-status");
        
        if (action === 'on') {
          pompaStatus.className = "pompa-status pompa-on blink";
          pompaStatus.innerHTML = "‚è≥ MENYALAKAN...";
          actualStatusElement.textContent = "Menunggu konfirmasi ESP32...";
          actualStatusElement.style.color = "#ffc107";
        } else {
          pompaStatus.className = "pompa-status pompa-off blink";
          pompaStatus.innerHTML = "‚è≥ MEMATIKAN...";
          actualStatusElement.textContent = "Menunggu konfirmasi ESP32...";
          actualStatusElement.style.color = "#ffc107";
        }

        fetch("/api/data/pompa", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            deviceId: "POMPA_CONTROL_WEB",
            status: action === "on",
            mode: "manual",
            controlled_by: "web-dashboard",
            timestamp: new Date().toLocaleTimeString(),
            date: new Date().toLocaleDateString(),
            command: action // PERBAIKAN: Tambah field command untuk tracking
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            button.innerHTML = originalText;
            console.log("‚úÖ Control response:", data);
            
            showNotification(
              `Perintah ${action === "on" ? "nyala" : "mati"} dikirim ke ESP32`,
              "success"
            );

            // PERBAIKAN: Tunggu update status dari ESP32 (akan datang via auto-refresh)
            // Jangan langsung update UI, tunggu data aktual dari ESP32
            
          })
          .catch((error) => {
            button.innerHTML = originalText;
            button.disabled = false;
            
            // Kembalikan status sebelumnya jika gagal
            updateDisplayFromESP32(lastPompaData);
            
            showNotification("Gagal mengirim perintah ke ESP32", "error");
            console.error("Error:", error);
          });
      }

      function toggleAutoMode() {
        if (!isPompaDeviceOnline) {
          showNotification("‚ùå Device pompa offline, tidak dapat mengubah mode", "error");
          return;
        }

        const mode = isAutoMode ? "manual" : "auto";

        fetch("/api/data/pompa", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            deviceId: "POMPA_CONTROL_WEB",
            status: currentPompaStatus,
            mode: mode,
            controlled_by: "web-dashboard",
            timestamp: new Date().toLocaleTimeString(),
            date: new Date().toLocaleDateString()
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            showNotification(`Mode ${mode} dikirim ke ESP32`, "success");
            // Status akan update otomatis via refresh
          })
          .catch((error) => {
            showNotification("Gagal mengubah mode", "error");
            console.error("Error:", error);
          });
      }

      function updateAutoButton() {
        const btnAuto = document.getElementById("btn-auto");
        if (isAutoMode) {
          btnAuto.innerHTML = "‚èπÔ∏è Nonaktifkan Mode Otomatis";
          btnAuto.style.background = "#dc3545";
        } else {
          btnAuto.innerHTML = "üîÑ Aktifkan Mode Otomatis";
          btnAuto.style.background = "#28a745";
        }
      }

      function updateSchedule() {
        const now = new Date();
        const hour = now.getHours();
        const minute = now.getMinutes();

        const morningSchedule = document.getElementById("schedule-morning");
        const eveningSchedule = document.getElementById("schedule-evening");

        // Update jadwal pagi
        if (hour === 6 && minute >= 0 && minute <= 15 && isAutoMode && isPompaDeviceOnline) {
          morningSchedule.innerHTML = "üíß Menyiram...";
          morningSchedule.className = "blink";
        } else {
          morningSchedule.innerHTML = "‚è≥ Menunggu...";
          morningSchedule.className = "";
        }

        // Update jadwal sore
        if (hour === 16 && minute >= 0 && minute <= 15 && isAutoMode && isPompaDeviceOnline) {
          eveningSchedule.innerHTML = "üíß Menyiram...";
          eveningSchedule.className = "blink";
        } else {
          eveningSchedule.innerHTML = "‚è≥ Menunggu...";
          eveningSchedule.className = "";
        }
      }

      function updateTable(data) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #666;">Belum ada riwayat kontrol</td></tr>`;
          return;
        }

        data.reverse().forEach((item) => {
          const status = item.status ? "üíß MENYALA" : "üî¥ MATI";
          const source = item.controlled_by === "web-dashboard" ? "Dashboard" : "ESP32";
          const row = `<tr>
                    <td>${item.timestamp || "N/A"}</td>
                    <td>${status}</td>
                    <td>${item.mode || "manual"}</td>
                    <td>${item.controlled_by || "system"}</td>
                    <td>${source}</td>
                </tr>`;
          tbody.innerHTML += row;
        });
      }

      function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

        if (type === "success") {
          notification.style.background = "#28a745";
        } else {
          notification.style.background = "#dc3545";
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      function startAutoRefresh() {
        refreshInterval = setInterval(() => {
          loadData();
        }, 2000); // Refresh lebih cepat untuk respons yang lebih baik
      }

      // Load data pertama kali
      loadData();

      // Start auto refresh
      startAutoRefresh();

      // Update schedule setiap menit
      setInterval(updateSchedule, 60000);

      // Debug function
      window.debugPompa = function() {
        console.log("üîß Debug Pompa Status:");
        console.log("- Pompa Device Online:", isPompaDeviceOnline);
        console.log("- Current Status:", currentPompaStatus);
        console.log("- Auto Mode:", isAutoMode);
        console.log("- Last Data:", lastPompaData);
        console.log("- Is Synced:", isSynced);
        loadData();
      }
    </script>
  </body>
</html>
